FROM node:14.17-alpine as build

# adding python for node-gyp
RUN apk add g++ make python

COPY . /app
WORKDIR /app

# Installing packages
RUN npm ci

# Building TypeScript files
RUN npm run build:release

FROM node:14.17-alpine
USER node

# Brahmos files for scaling testing
COPY --from=docker.atl-paas.net/sox/brahmos-deps/stress-ng:latest /usr/bin/stress-ng /usr/bin/stress-ng

COPY --chown=node:node --from=build /app /app
WORKDIR /app
ENV NODE_ENV production

CMD ["./bin/start-server-micros.sh"]
